---
title: Consul çš„åŸºæœ¬ä½¿ç”¨ï¼šæœåŠ¡æ³¨å†Œå’Œè‡ªåŠ¨å‘ç°
date: 2022-04-28
categories:
 - Consul
 - å¾®æœåŠ¡
tags:
 - Consul

publish: false
---

å†™è¿™ç¯‡ blog çš„èµ·å› æ˜¯å…¬å¸å¼€å§‹å°è¯•åŸºäº consul å®è·µ service meshï¼Œåœ¨ä¸æ–­å­¦ä¹ è¿‡ç¨‹ä¸­ç¢°åˆ°ä¸€äº›æœ‰è¶£çš„é—®é¢˜ï¼Œä¹Ÿå‘ç°è¿™æ˜¯ä¸€ä¸ªåºå¤§çš„çŸ¥è¯†ä½“ç³»ï¼Œä¸æ˜¯ä¸€äº›ç®€å•çš„ä¸ªäººç¬”è®°èƒ½å½’çº³çš„ï¼Œæ‰€ä»¥å†³å®šç”¨ blog è¿™ç§å…¬å¼€çš„æ–¹å¼ä¸¥è°¨çš„è®°å½•ä¸‹æ¥ï¼Œæä¾›ç»™è‡ªå·±å¤ä¹ å’Œæœ‰ç¼˜äººã€‚

æœ¬ç¯‡å±äº consul çš„å…¥é—¨æ•™ç¨‹ï¼Œåç»­ä¼šå»¶ä¼¸åˆ° service mesh ç­‰å†…å®¹ã€‚


## æœåŠ¡æ³¨å†Œå’Œè‡ªåŠ¨å‘ç°

å®é™…ä¸Šï¼Œè‡ªä» docker å¼€å§‹æµè¡Œåï¼Œå¾®æœåŠ¡ä»¥åŠå¾®æœåŠ¡ç›¸å…³è”çš„å‡ ä¸ªåè¯ï¼šã€ŒæœåŠ¡æ³¨å†Œã€ã€ã€Œè‡ªåŠ¨å‘ç°ã€ç­‰å·²ç»è¢«æåŠå¾ˆå¤šéäº†ï¼Œä¸è¿‡ä¸ºäº†æ–‡ç« é˜…è¯»çš„å®Œæ•´æ€§ï¼Œè¿™é‡Œç”¨æˆ‘çš„ç†è§£è§£é‡Šä¸‹ã€ŒæœåŠ¡æ³¨å†Œã€å’Œã€Œè‡ªåŠ¨å‘ç°ã€ã€‚


ä»ä¸€å¼€å§‹ï¼Œå…¬å¸çš„æŸä¸ªé¡¹ç›®åªæœ‰ä¸€ä¸ªä»“åº“ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½åœ¨è¿™ä¸ªä»“åº“ä¸­ï¼Œéšç€ä¸šåŠ¡å‘å±•ä»£ç è¶Šæ¥è¶Šå¤šï¼Œäºæ˜¯è‡ªç„¶è€Œç„¶æœ‰äººæå‡ºï¼šæˆ‘ä»¬æŠŠä»£ç æŒ‰ç…§ä¸šåŠ¡æ‹†åˆ†æˆå¤šä¸ªæ¨¡å—å§ï¼Œç„¶åé€šè¿‡ API æ¥å£äº’ç›¸è°ƒç”¨å§ï¼è¿™ä¸ªæƒ³æ³•å°±æ˜¯å¾®æœåŠ¡çš„æ¦‚å¿µï¼š**å°†ä¸€ä¸ªåºå¤§çš„é¡¹ç›®æ ¹æ®æŸäº›é€»è¾‘æ‹†åˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ä¹‹é—´é€šè¿‡ API äº’ç›¸è°ƒç”¨ã€‚**

ç›¸å¯¹äºä¸€ä¸ªä»£ç ä»“åº“è€Œè¨€ï¼Œè¿™ç§èŒæ–°çš„å¾®æœåŠ¡å…·å¤‡ä¸€äº›ä¼˜åŠ¿ï¼š
1. æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹ä¸Šçº¿ï¼Œå°¤å…¶å¯¹äºé‚£ç§éœ€è¦ç¼–è¯‘çš„è¯­è¨€ï¼Œä¸€ä¸ªåºå¤§çš„ä»£ç ä»“åº“ç¼–è¯‘éœ€è¦å¾ˆä¹…çš„æ—¶é—´ï¼Œæ‹†åˆ†ä»£ç ä¹‹åå¯ä»¥èŠ‚çœå¾ˆå¤šç¼–è¯‘æ—¶é—´
2. æµ‹è¯•æ–¹ä¾¿
3. å¯ä»¥æŠŠã€Œå±ã€å’Œã€Œå·§å…‹åŠ›ã€åˆ†å¼€ï¼šé¡¹ç›®ä»£ç ä¸­ä¼šå­˜åœ¨ä¸€äº›ç³Ÿç³•ä½†æ˜¯å¯ä»¥è¿è¡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘æŠŠè¿™äº›ã€Œå±ã€ä»£ç ç‹¬ç«‹æˆä¸€ä¸ªæ¨¡å—åˆ†ç¦»å‡ºæ¥ï¼Œä¿è¯ä»£ç å¯ä»¥è¿è¡Œï¼Œåç»­å…¶ä»–æ¨¡å—åªéœ€è¦é€šè¿‡ API è°ƒç”¨å³å¯ï¼Œä¸ç”¨å…³å¿ƒä»£ç çš„å¤æ‚é€»è¾‘ã€‚

> å…³äºç¬¬ 3 ç‚¹å±•å¼€è®²ä¸€ä¸‹æˆ‘å¯¹äºã€Œé‡æ„ä»£ç ã€çš„æƒ³æ³•ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæ¯”è¾ƒå¥½çš„åšæ³•ä¸æ˜¯ç›´æ¥æŠŠç³Ÿç³•çš„ä»£ç é‡å†™ï¼Œè€Œæ˜¯å°½é‡æŠŠç³Ÿç³•çš„ä»£ç å’Œè‰¯å¥½çš„ä»£ç åˆ†å¼€ï¼Œè®©ç³Ÿç³•çš„ä»£ç å¯ä¿æŒç‹¬ç«‹çš„é€»è¾‘è¿è¡Œï¼Œå¯¹å¤–æä¾›è°ƒç”¨æ–¹å¼ã€‚è€Œååœ¨ç³Ÿç³•çš„ä»£ç ä¸­ç»§ç»­åˆ†ç¦»ï¼Œç›´åˆ°æ¶ˆç­ç³Ÿç³•çš„ä»£ç ã€‚

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/20220429111015.png)

ç°åœ¨æˆ‘ä»¬å·²ç»æŠŠä»£ç åˆ’åˆ†æˆ 3 ä¸ªæ¨¡å—ï¼Œç”±äºæœåŠ¡ä¹‹é—´éœ€è¦é€šè¿‡ API é€šä¿¡ï¼Œäºæ˜¯æˆ‘ä»¬ä¼šåœ¨æ¨¡å—çš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ¯ä¸ªæ¨¡å—çš„åœ°å€ï¼š

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/202204291119614.png)

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ¨é¡¹ç›®ä¸­å®è·µå¾®æœåŠ¡äº†ï¼

ä¸è¿‡ï¼Œæˆ‘ä»¬ä¼šç¢°åˆ°æ–°çš„é—®é¢˜ï¼š

1. service A çš„åœ°å€ä¸æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®šé…ç½®æ–‡ä»¶ä¸­ service_a_host` çš„å€¼ã€‚
2. æŸä¸ªæ¨¡å—å¯èƒ½è®¿é—®é‡ç‰¹åˆ«å¤§ï¼Œå¯¼è‡´è¯¥æ¨¡å—è®¿é—®é€Ÿåº¦ç¼“æ…¢ã€‚

è¿™ 2 ä¸ªä¸æ˜¯æˆ‘éšä¾¿æ‰¯å‡ºæ¥çš„é—®é¢˜ï¼Œåœ¨å¾®æœåŠ¡çš„å®è·µä¸­å¿…ç„¶ä¼šç¢°åˆ°çš„ã€‚

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼š

1. ç‹¬ç«‹èµ·ä¸€ä¸ªã€Œæ³¨å†Œä¸­å¿ƒã€çš„æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—åœ¨å¯åŠ¨ä¹‹åï¼Œéƒ½å‘æ³¨å†Œä¸­å¿ƒæŠ¥å‘Šè‡ªå·±çš„æœåŠ¡åç§°å’Œè®¿é—®åœ°å€ï¼Œç±»ä¼¼äº `service_name => service_host` çš„ kvï¼Œå…¶ä¸­æœåŠ¡åç§°å¯ä»¥è‡ªå®šä¹‰ï¼Œå¹¶ä¸”å…¨å±€å”¯ä¸€ã€‚
2. å½“ A service è¦è¯·æ±‚ B service æ¥å£æ—¶ï¼Œæ‹¿ç€ B service çš„æœåŠ¡åç§°è¯¢é—®æ³¨å†Œä¸­å¿ƒï¼šB service çš„è®¿é—®åœ°å€æ˜¯å¤šå°‘ï¼Œæ³¨å†Œä¸­å¿ƒè¿”å›è¯¥åœ°å€ï¼ŒA service å°±å¯ä»¥é€šè¿‡è¯¥åœ°å€è®¿é—® B serviceã€‚


ç¬¬ 1 ç‚¹æåˆ°çš„ã€Œæ¯ä¸ªæ¨¡å—åœ¨å¯åŠ¨ä¹‹åï¼Œéƒ½å‘æ³¨å†Œä¸­å¿ƒæŠ¥å‘Šè‡ªå·±çš„æœåŠ¡åç§°å’Œè®¿é—®åœ°å€ã€å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ã€ŒæœåŠ¡æ³¨å†Œã€ã€‚ç¬¬ 2 ç‚¹é€šè¿‡æ³¨å†Œä¸­å¿ƒè·å–åˆ°å…¶ä»–æœåŠ¡çš„åœ°å€å°±æ˜¯ã€Œè‡ªåŠ¨å‘ç°ã€ã€‚

ç°åœ¨æˆ‘ä»¬æ˜ç™½äº†ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œå’Œè‡ªåŠ¨å‘ç°ï¼Œè¿™ä¸¤ä¸ªç»„åˆåœ¨ä¸€èµ·**è§£å†³äº†å¾®æœåŠ¡ä¸­å„ä¸ªæ¨¡å—æ— æ³•ç›¸äº’è®¿é—®çš„é—®é¢˜ã€‚**


## åœ¨ Consul ä¸­å®è·µæœåŠ¡æ³¨å†Œå’Œè‡ªåŠ¨å‘ç°

ä¸Šé¢è§£é‡ŠæœåŠ¡æ³¨å†Œå’Œè‡ªåŠ¨å‘ç°çš„æ—¶å€™ï¼Œæåˆ°äº†ã€Œæ³¨å†Œä¸­å¿ƒã€ã€‚[Consul](https://consul.io/) åœ¨è¿™é‡Œå°±æ˜¯æ‰®æ¼”æ³¨å†Œä¸­å¿ƒçš„è§’è‰²ã€‚é™¤äº† Consulï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–æ¡†æ¶ï¼Œæ¯”å¦‚ï¼šistioã€Eurekaã€Zookeeper ç­‰ç­‰éƒ½å¯ä»¥ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚

ä¸‹é¢æˆ‘ä»¬å¼€å§‹åŸºäº Consul æ¥æ‰‹åŠ¨å®è·µä¸‹ã€‚


### Consul çš„åŸºæœ¬æ¦‚å¿µ

Consul ä½¿ç”¨ Go å¼€å‘ï¼Œè¿™æ„å‘³ç€åªéœ€è¦ä¸€ä¸ª bin æ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œä¸è¿‡åç»­æˆ‘ä»¬è¿˜æ˜¯ä¼šä½¿ç”¨ docker æ¥å®è·µã€‚

Consul ä¸­æœ‰ä¸¤ä¸ªè§’è‰²ï¼š
1. server
2. client

ä»£å…¥åˆ°ä¸Šé¢çš„æè¿°ï¼Œserver æ˜¯ä¸Šé¢æåˆ°çš„æ³¨å†Œä¸­å¿ƒï¼Œè€Œ client ä¼šå°†å¾®æœåŠ¡æ¨¡å—çš„è®¿é—®åœ°å€ä¸ŠæŠ¥ç»™ serverã€‚è¿™æ · consul å°±æ»¡è¶³æˆ‘ä»¬å¯¹äºå¾®æœåŠ¡çš„åŸºæœ¬éœ€æ±‚ã€‚

ç”±äºæ‰€æœ‰çš„æ¨¡å—éƒ½éœ€è¦å’Œæ³¨å†Œä¸­å¿ƒé€šä¿¡ï¼Œæ‰€ä»¥æ³¨å†Œä¸­å¿ƒå˜å¾—éå¸¸é‡è¦ï¼Œå¦‚æœæ³¨å†Œä¸­å¿ƒæŒ‚äº†ï¼Œæ•´ä¸ªç³»ç»Ÿå°±æŒ‚äº†ã€‚consul ä¸ºäº†ä¿è¯ server çš„ç¨³å®šæ€§ï¼Œæ”¯æŒ server ä»¥é›†ç¾¤çš„æ¨¡å¼éƒ¨ç½²ï¼Œä»¥ raft åè®®ä»æ‰€æœ‰çš„ server ä¸­é€‰ä¸¾ leaderã€‚ä¸è¿‡æˆ‘ä»¬ç›®å‰ä¸ä¼šæ·±å…¥é›†ç¾¤æ¨¡å¼ï¼Œæ–°æ‰‹ä»»åŠ¡ä¸è¦è¿‡æ—©å»æ‰“ raft è¿™ä¸ªæ€ªã€‚ğŸ˜‚

æ­¤å¤–ï¼Œconsul è¿˜æœ‰ datacenter çš„æ¦‚å¿µï¼Œå¯¹äºè¶…å¤§å‹ç³»ç»Ÿè€Œè¨€ï¼Œä¼šåœ¨åŒ—äº¬å’Œå¹¿å·å„éƒ¨ç½²ä¸€å¥— consul é›†ç¾¤ï¼Œè¿™æ ·å°±æœ‰äº†ä¸¤ä¸ª consul datacenterï¼Œä¸¤ä¸ª datacenter é€šè¿‡ç½‘ç»œäº’é€šã€‚


### Consul ä¸Šæ‰‹å®è·µ

äº†è§£ä¸Šé¢çš„æ¦‚å¿µä¹‹åï¼Œå°±è¶³å¤Ÿæˆ‘ä»¬æ“ä½œ consul äº†

1. ä»¥ server è§’è‰²å¯åŠ¨ä¸€ä¸ª consulï¼š
```bash
// --server=true è¡¨ç¤ºä»¥ server å¯åŠ¨ consul
// --bootstrap-expect=1 è¡¨ç¤ºé›†ç¾¤ä¸­éœ€è¦å¯åŠ¨äº†å¤šå°‘ä¸ª server æ•´ä¸ªé›†ç¾¤æ‰ç®—å¯åŠ¨æˆåŠŸï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®ä¸º 1 å³å¯ã€‚
docker run -d --name=consul-server -p 8500:8500 consul agent --server=true --bootstrap-expect=1  --client=0.0.0.0 -ui
```


2. æ‰§è¡Œ `docker inspect consul-server | grep IP` è·å–åˆ° consul-server çš„ IP
```bash
â¯ docker inspect consul1  |grep IP
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "172.17.0.2",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
                    "IPAMConfig": null,
                    "IPAddress": "172.17.0.2",  //consul-server çš„ IP åœ°å€
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
```
3. ä»¥ client è§’è‰²å¯åŠ¨å¦ä¸€ä¸ª consulï¼Œå¹¶è¿æ¥åˆ° consul-server

```bash
docker run --name=consule-client -d consul agent  -join=172.17.0.2
```

æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥é€šè¿‡ http://localhost:8500 è®¿é—® consul

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/202204291625193.png)

é™¤äº† web uiï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡ŒæŸ¥çœ‹ä¿¡æ¯ï¼š

```bash
docker exec -it consul-server sh
consul members

Node          Address          Status  Type    Build   Protocol  DC   Partition  Segment
f6e25729245f  172.17.0.2:8301  alive   server  1.11.4  2         dc1  default    <all>
7f45cf74e866  172.17.0.3:8301  alive   client  1.11.4  2         dc1  default    <default>
```
Type å­—æ®µç”¨äºåŒºåˆ† consul è§’è‰²ã€‚

äº†è§£äº† consul çš„å¯åŠ¨æ“ä½œï¼Œç°åœ¨æˆ‘ä»¬æ¨¡æ‹Ÿä¸¤ä¸ªæœåŠ¡ï¼Œæ¥å®è·µä¸‹æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ã€‚